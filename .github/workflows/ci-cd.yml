name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  validate-contracts:
    name: Validate API Contracts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Validate contracts
        run: |
          chmod +x validate-contracts.sh
          ./validate-contracts.sh

  lint-and-test:
    name: Lint and Test
    runs-on: ubuntu-latest
    needs: validate-contracts
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Black (code formatting check)
        run: |
          black --check . || echo "Black check failed (not blocking)"

      - name: Run Flake8 (linting)
        run: |
          flake8 lambdas/ shared/ --max-line-length=120 || echo "Flake8 check failed (not blocking)"

      - name: Run MyPy (type checking)
        run: |
          mypy lambdas/ shared/ --ignore-missing-imports || echo "MyPy check failed (not blocking)"

      - name: Run pytest
        run: |
          pytest tests/ -v || echo "Tests not yet implemented"

  package:
    name: Package Lambda Functions
    runs-on: ubuntu-latest
    needs: lint-and-test
    strategy:
      matrix:
        function:
          - sam-gov-daily-download
          - sam-json-processor
          - sam-sqs-generate-match-reports
          - sam-daily-email-notification
          - sam-email-notification
          - sam-merge-and-archive-result-logs
          - sam-produce-user-report
          - sam-produce-web-reports
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Package Lambda function
        run: |
          mkdir -p packages/${{ matrix.function }}
          
          # Copy function code
          cp -r lambdas/${{ matrix.function }}/* packages/${{ matrix.function }}/
          
          # Copy shared libraries
          cp -r shared/ packages/${{ matrix.function }}/
          
          # Install dependencies
          if [ -f lambdas/${{ matrix.function }}/requirements.txt ]; then
            pip install -r lambdas/${{ matrix.function }}/requirements.txt -t packages/${{ matrix.function }}/
          fi
          
          # Create deployment package
          cd packages/${{ matrix.function }}
          zip -r ../${{ matrix.function }}.zip . -x "*.pyc" "*__pycache__*" "*.git*"
          cd ../..

      - name: Upload Lambda package
        uses: actions/upload-artifact@v4
        with:
          name: lambda-${{ matrix.function }}
          path: packages/${{ matrix.function }}.zip
          retention-days: 7

  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: package
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment:
      name: development
    strategy:
      matrix:
        function:
          - sam-gov-daily-download
          - sam-json-processor
          - sam-sqs-generate-match-reports
          - sam-daily-email-notification
          - sam-email-notification
          - sam-merge-and-archive-result-logs
          - sam-produce-user-report
          - sam-produce-web-reports
    steps:
      - name: Download Lambda package
        uses: actions/download-artifact@v4
        with:
          name: lambda-${{ matrix.function }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Deploy to Lambda
        run: |
          aws lambda update-function-code \
            --function-name dev-${{ matrix.function }} \
            --zip-file fileb://${{ matrix.function }}.zip

      - name: Wait for update to complete
        run: |
          aws lambda wait function-updated \
            --function-name dev-${{ matrix.function }}

  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: package
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
    strategy:
      matrix:
        function:
          - sam-gov-daily-download
          - sam-json-processor
          - sam-sqs-generate-match-reports
          - sam-daily-email-notification
          - sam-email-notification
          - sam-merge-and-archive-result-logs
          - sam-produce-user-report
          - sam-produce-web-reports
    steps:
      - name: Download Lambda package
        uses: actions/download-artifact@v4
        with:
          name: lambda-${{ matrix.function }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Deploy to Lambda
        run: |
          aws lambda update-function-code \
            --function-name prod-${{ matrix.function }} \
            --zip-file fileb://${{ matrix.function }}.zip \
            --publish

      - name: Wait for update to complete
        run: |
          aws lambda wait function-updated \
            --function-name prod-${{ matrix.function }}

      - name: Create version alias
        run: |
          VERSION=$(aws lambda list-versions-by-function \
            --function-name prod-${{ matrix.function }} \
            --query 'Versions[-1].Version' --output text)
          
          aws lambda update-alias \
            --function-name prod-${{ matrix.function }} \
            --name live \
            --function-version $VERSION || \
          aws lambda create-alias \
            --function-name prod-${{ matrix.function }} \
            --name live \
            --function-version $VERSION
